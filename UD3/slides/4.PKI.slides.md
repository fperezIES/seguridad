
<!-- .slide: data-background="#2C3E50" -->
# **Infraestructura de Clave Pública**
## PKI
### Public Key Infraestructure

---




# Criptografía


## Funciones Hash

### Funciones Hash

> A las funciones ***hash*** también se las denomina funciones **resumen** o funciones ***digest***

Son funciones que asocian a cada documento un número de longitud fija que cumple las siguientes propiedades: 

* Debe ser muy difícil que dos documentos distintos tengan el mismo resumen (**Colisión**), aunque solo cambie un carácter.
* Debe ser muy difícil, por no decir imposible, crear un documento a partir del valor de su resumen. Deben ser **funciones de un solo sentido**. 


### Usos de las funciones Hash

* Se emplean para **evaluar la integridad** de un documento, asegurando que no ha sido modificado
	* Se usa en **firma electrónica**
	* **Comprobación de descargas**
	 
* **Almacenamiento de contraseñas**
	* En lugar de texto en claro se guarda hash asociado a contraseña
		*  En Linux las contraseñas de los usuarios se encuentran en el fichero `/etc/shadow` almacenadas como un valor ***salted hash***.
 
### Funciones Hash

* **MD5** (Message-Digest Algorithm 5)
	*  128 bits. Creado para uso criptográfico, pero presenta vulnerabilidades (**Colisiones**). 
	* Actualmente roto, no se considera seguro para almacenar passwords.
 	
* **SHA** (Secure Hash Algorithm)
	* Existen diferentes versiones (SHA256, SHA512, ...)
	* Ha sustituido a MD5 en el almacenamiento de passwords


### Problemas funciones Hash

**Colisiones**: Documentos distintos que tienen el mismo Hash

**Resolución inversa**: Obtener un documento que tenga el mismo *hash* que el original a partir del valor de hash

* Nos permitiría construir una contraseña a partir de un valor hash
	* Puede que sea distinta a la original, pero permitiría acceder igualmente
* Nos permitiría reutilizar una firma de un documento en el otro
	* En otras palabras, permite falsificar documentos


### Salted Hash

* **Tablas rainbow**
	* Son tablas en las que aparecen listas de contraseñas con sus hash asociados, son usadas para encontrar de forma rápida contraseñas a partir de un valor hash

* **Salted hash**
	* Técnica para contrarrestar las tablas raiwbow
	* En lugar de calcular el hash de la contraseña, se calcula el hash de la contraseña + un texto aleatorio (al que se conoce como *salt*). 
	* Es necesario almacenar tanto el salt como el hash para poder hacer la verificación de la contraseña

### Ejemplo /etc/shadow

Consiste en una serie de campos separados por `:`

El primer campo el el nombre de usuario. 

El segundo campo es el password codificado de la siguietne forma: 

> `$código$salt$resultado_hash`

```sh
fperez:$6$sTgBhfj0$pkzz/JpVTl8ZAmk./d4SDarRyWsGSZHguljywUHQMP4DWo8/TgNzL5rMpejqNWuyxtFlISxdyIqPmpsIsyi.i1:16088:0:99999:7: : :
```



| Code |        Algorithm       |
|------|------------------------|
|  $1  | MD5 hashing algorithm  |
|  $5  | SHA-256 Algorithm      |
| **$6**  | **SHA-512 Algorithm **     |
+------+------------------------+

<!--
|  $2  | Blowfish Algorithm     |
|  $3  | Eksblowfish Algorithm  |
|  $4  | NT hashing algorithm   |
-->

## Firma Digital

### Firma Digital: Generación

![Firma Digital](img/04/firma.png){height=100%}

### Firma Digital: Generación
La firma digital equivale a la manuscrita en el mundo de la informática.
 
Mecanismo de firma electrónica :

1. Se calcula un valor **resumen** del documento, utilizando algún algoritmo de ***hash***, como SHA.
	- De este modo, si cambia el texto original el resumen ya no será válido. 

2. Este valor resumen se cifra utilizando la clave privada de nuestra pareja de claves asimétricas.
	- Esto permite asegurar que la única persona que ha podido firmar el documento es la que tiene la clave privada.

3. El resultado es lo que se conoce como firma digital del documento



### Firma Digital: Verificación
El proceso de comprobación de una firma digital:

* La firma se descifra utilizando la clave pública del firmante
	* Se obtiene el valor resumen del documento.
* Se obtiene el valor resumen del documento utilizando el mismo algoritmo que en el proceso de cifrado, por ejemplo el SHA.
* Por último se comparan los dos valores resúmenes obtenidos en los dos procesos anteriores 
	* Si coinciden entonces la firma es válida
	* Si estos son distintos la firma será nula.




## PKI (*Public Key Infrastructure*)

### PKI: Introducción

* La ventaja de la criptografía asimétrica es su facilidad para difundir la clave pública
* Pero cualquiera puede generar un par de claves y pretender ser otra persona

> Problema: **¿Cómo puedo estar seguro que el dueño de una clave pública es realmente quien dice ser?**

#### Solución: 
Tercera parte de confianza que verifique la identidad del dueño de la clave. (**Autoridad de Certificación**)

#### Certificado:
Es clave pública firmada por una Autoridad de Certificación 

### PKI: Definición

Infraestructura de clave pública o PKI (Public Key Infraestructure) 

> Por PKI se entiende el conjunto de herramientas 
> hardware, software, 
> procesos y procedimientos legales 
> que permiten crear, gestionar, almacenar, distribuir y revocar certificados digitales.

Este término incluye por tanto las autoridades de certificación y al resto de elementos que participan como los certificados digitales o los algoritmos de clave pública y firma digital en comunicaciones  y transacciones electrónicas.

### Componentes PKI

* La **Autoridad de Certificación** (**CA** [Certificate Authority]), 
	- Su misión es emitir certificados
* La **Autoridad de Registro** (**RA** [Registration Authority]), 
	- Es la responsable de asegurar que el solicitante del certificado es quien dice ser. 
* La **Autoridad de Validación** (**VA** [Validation Authority]) 
	- Suministra información de forma online (en tiempo real) acerca del estado de un certificado 
* Los **repositorios** (o Directorios) 
	- Son almacenes de certificados. 
	- Los principales son el repositorio de certificados activos y el repositorio de **listas de revocación** de certificados (certificados que, por  cualquier motivo, fueron expresamente desactivados antes de caducar)

### Componentes PKI

![Componentes PKI](img/04/pki_componentes.png){width=100%}
	

### Certificados

> Un certificado digital es un documento digital mediante el cual un tercero confiable (una autoridad de certificación) garantiza la vinculación entre la identidad de un sujeto o entidad y su clave pública. 

Existen variados formatos para certificados digitales, los más comúnmente empleados se rigen por el estándar **UIT-T X.509**.

Básicamente un certificado digital es una clave pública de un usuario o servicio, firmada digitalmente con la clave privada de una Autoridad de Certificación 

#### Ejemplo
DNI electrónico: la AC de la Policía Nacional firma digitalmente las claves del certificado ciudadano que está se guarda en el chip de su DNI



### Tipos Certificados: según su uso

* Personales
* Servidor
* Software
* Entidad de certificación

		
### Tipos Certificados: según validación

* **Domain Validated (DV)**: nivel más bajo de verificación, porque sólo se comprueba que el dominio pertenece al solicitante. 
	
* **Organization Validated (OV)**: tienen un nivel más alto de confianza porque además de comprobar el dominio, verifican la identidad de la organización a la que pertenece el dominio. 
* **Extended Validation (EV)**: son los más seguros y confiables y a la vez los más **caros** porque requieren un **proceso de validación mucho más complejo** por parte de la AC y la solicitud de mucha documentación a la organización solicitante. 
	
### Tipos Certificados: según validación

* **Domain Validated (DV)**: nivel más bajo de verificación, porque sólo se comprueba que el dominio pertenece al solicitante. 
- La confirmación por parte de la AC se hace:
	- enviando un email al correo que figura en la información de la base de datos whois del dominio registrado 
	- o bien enviando un archivo de verificación que el solicitante coloca en el sitio web para que la AC compruebe que le pertenece dicho dominio.


### Tipos Certificados: según validación


* **Organization Validated (OV)**: tienen un nivel más alto de confianza porque además de comprobar el dominio, verifican la identidad de la organización a la que pertenece el dominio. 
* **El nombre de la organización** también aparecerá en el certificado, dando confianza añadida de que tanto el sitio web como la compañía son de confianza. 
* Suelen ser utilizados por empresas, gobiernos y otras entidades que desean proporcionar una capa adicional de confianza para sus visitantes.

	
### Tipos Certificados: según validación


* **Extended Validation (EV)**: son los más seguros y confiables y a la vez los más caros porque requieren un **proceso de validación mucho más complejo** por parte de la AC y la solicitud de mucha documentación a la organización solicitante. 
- Además de mostrar el nombre de la organización en el certificado, también **aparecerá en color verde en la barra de direcciones**, al lado del candado. 
- Lamentablemente, algunos navegadores como Firefox o Chrome han decido **eliminar la barra verde** debido a que consideran que los usuarios no aprecian esta función. 


### Certificado: BBVA

![Home de banco BBVA](img/04/cert.bbva.barra.png){width=100%}

### Certificado: BBVA

:::::::::::::: {.columns}
::: {.column width="50%"}
![](img/04/cert.bbva.detalles.png){width=100%}
:::
::: {.column width="50%"}
![](img/04/cert.bbva.seguridad.png){width=100%}
:::
::::::::::::::


### Certificado: Santander 
	
- Todos los bancos deberían usar certificados de tipo Extended Validation
	- Desgraciadamente algunos, como Banco Santander, no lo hacen

![Home de banco Santander](img/04/cert.santander.barra.png){width=100%}


### Certificado: Santander

:::::::::::::: {.columns}
::: {.column width="50%"}
![](img/04/cert.santander.detalles.png){width=100%}
:::
::: {.column width="50%"}
![](img/04/cert.santander.seguridad.png){width=100%}
:::
::::::::::::::


### Autoridad de certificación

> La AC es  una entidad fiable y reconocida regional o mundialmente, encargada de garantizar de forma unívoca y segura la identidad asociada a una clave pública. 

* Realiza las siguientes tareas:
	- Recibe y procesa peticiones de certificados (CSR) de los usuarios finales. 
	- Consulta con una Autoridad de Registro para determinar si acepta o rehúsa la petición de certificado
	- Emite el certificado
	- Gestiona Listas de Revocación de Certificados (CRLs)
	- Renueva certificados


### Autoridad de certificación

Algunas de las principales autoridades certificadoras son:

* Internacionales: DigiCert, GlobalSign, Thawte Certification, Comodo, etc  

* En España: FNMT, ACCV (GVA), Edicom, etc  

> Cualquiera puede crear su propia AC con el software adecuado (por ejemplo Openssl). El problema es generar reputación y confianza por el resto para ser incluido en los repositorios de AC, como las que vienen de serie en nuestro navegador

### PKI: Tipos

Tipos:

* **Públicas**, gestionadas por el gobierno, normalmente para identificar personas y entidades públicas.
* **Privadas**, gestionadas por empresas privadas, usadas para verificar identidad de servidores frente a consumidores
* **Propias**, para cifrar y verificar comunicaciones dentro de una empresa
	* Ahorro de costes respecto a PKI privada.

* Vulnerabilidades:
	* CA fraudulentas
	* Un virus podría importar claves públicas de CA fraudulentas
	* Posible robo de clave privada de CA, permitiría falsificar certificados y suplantar servidores sin que los clientes se percataran


